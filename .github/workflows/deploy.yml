name: Deploy to VM

on:
  push:
    branches: [main]
  workflow_dispatch: {}

permissions:
  contents: read

env:
  DEPLOY_DIR: /home/elmudyr/shellgate

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Preflight validations
        run: |
          set -e
          echo "Validating required secrets and files..."
          if [ -z "${{ secrets.VM_HOST }}" ] || [ -z "${{ secrets.VM_USER }}" ]; then
            echo "VM_HOST or VM_USER is missing in repo secrets" >&2
            exit 1
          fi
          if [ -z "${{ secrets.VM_SSH_KEY }}" ] && [ -z "${{ secrets.VM_PASSWORD }}" ]; then
            echo "Provide either VM_SSH_KEY (private key) or VM_PASSWORD in repo secrets" >&2
            exit 1
          fi
          if [ ! -f ./docker-compose.yml ]; then
            echo "docker-compose.yml not found at repo root" >&2
            exit 1
          fi

      - name: Prepare deploy directory on VM
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          password: ${{ secrets.VM_PASSWORD }}
          passphrase: ${{ secrets.VM_SSH_PASSPHRASE }}
          port: ${{ secrets.VM_SSH_PORT }}
          script: |
            set -e
            mkdir -p "${{ env.DEPLOY_DIR }}"
            echo "Deploy directory prepared: ${{ env.DEPLOY_DIR }}"

      - name: Upload repository to VM
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          password: ${{ secrets.VM_PASSWORD }}
          passphrase: ${{ secrets.VM_SSH_PASSPHRASE }}
          port: ${{ secrets.VM_SSH_PORT }}
          source: "."
          target: "${{ env.DEPLOY_DIR }}"
          timeout: 120s
          debug: true

      - name: Deploy on VM (docker compose build & up)
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          password: ${{ secrets.VM_PASSWORD }}
          passphrase: ${{ secrets.VM_SSH_PASSPHRASE }}
          port: ${{ secrets.VM_SSH_PORT }}
          script: |
            set -e
            cd ${{ env.DEPLOY_DIR }}
            if [ ! -f .env ]; then
              echo ".env missing in $PWD. Create it with your runtime secrets before deploying." >&2
              exit 1
            fi
            # Use Docker Compose plugin if available; fallback to docker-compose
            if docker compose version >/dev/null 2>&1; then
              docker compose -f docker-compose.yml up -d --build
            else
              docker-compose -f docker-compose.yml up -d --build
            fi
            docker image prune -f
